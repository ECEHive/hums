# =============================================================================
# Web Dockerfile
# Produces an optimized NGINX image serving the client and kiosk static files
# =============================================================================

# =============================================================================
# Base Stage - Bun for building
# =============================================================================
FROM oven/bun:1-alpine AS base

WORKDIR /app

# =============================================================================
# Dependencies Stage - Install all dependencies
# =============================================================================
FROM base AS deps

# Copy workspace manifests and workspaces
# .dockerignore ensures node_modules and build outputs are excluded
COPY package.json bun.lock ./
COPY apps ./apps
COPY packages ./packages

# Install all dependencies
RUN bun install --frozen-lockfile

# =============================================================================
# Build Client Stage
# =============================================================================
FROM deps AS build-client

# Source files are already present from deps stage
# Build client
WORKDIR /app/apps/client
RUN bun run build
WORKDIR /app

# =============================================================================
# Build Kiosk Stage
# =============================================================================
FROM deps AS build-kiosk

# Build kiosk
WORKDIR /app/apps/kiosk
RUN bun run build
WORKDIR /app

# =============================================================================
# Build Overview Stage
# =============================================================================
FROM deps AS build-overview

# Build overview
WORKDIR /app/apps/overview
RUN bun run build
WORKDIR /app

# =============================================================================
# Build Inventory Stage
# =============================================================================
FROM deps AS build-inventory

# Build inventory
WORKDIR /app/apps/inventory
RUN bun run build
WORKDIR /app

# =============================================================================
# Production NGINX Image
# =============================================================================
FROM nginx:alpine AS web

# Copy built static files
COPY --from=build-client /app/apps/client/dist /usr/share/nginx/html/client
COPY --from=build-kiosk /app/apps/kiosk/dist /usr/share/nginx/html/kiosk
COPY --from=build-overview /app/apps/overview/dist /usr/share/nginx/html/overview
COPY --from=build-inventory /app/apps/inventory/dist /usr/share/nginx/html/inventory

# Copy nginx configuration
COPY nginx.conf /etc/nginx/nginx.conf

# Expose HTTP port
EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost/ || exit 1

CMD ["nginx", "-g", "daemon off;"]
