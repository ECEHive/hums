generator client {
  provider = "prisma-client"
  output   = "./generated"
  runtime  = "bun"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       Int                    @id @default(autoincrement())
  username                 String                 @unique
  name                     String
  email                    String                 @unique
  cardNumber               String?                @unique
  isSystemUser             Boolean                @default(false)
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @default(now()) @updatedAt
  slackUsername            String?                @unique
  apiTokens                ApiToken[]
  impersonatedAuditLogs    AuditLog[]             @relation("AuditLogImpersonators")
  auditLogs                AuditLog[]
  inventoryTransactions    InventoryTransaction[]
  securitySnapshots        SecuritySnapshot[]
  sessions                 Session[]
  reviewedAttendances      ShiftAttendance[]      @relation("ShiftAttendanceReviewedBy")
  attendances              ShiftAttendance[]
  createdSuspensions       Suspension[]           @relation("SuspensionCreatedBy")
  suspensions              Suspension[]
  handledTickets           Ticket[]               @relation("TicketHandler")
  submittedTickets         Ticket[]               @relation("TicketSubmitter")
  ticketStatusChanges      TicketStatusHistory[]  @relation("TicketStatusChangedBy")
  userAgreements           UserAgreement[]
  roles                    Role[]                 @relation("RoleToUser")
  shiftOccurrences         ShiftOccurrence[]      @relation("ShiftOccurrenceToUser")
  shiftSchedules           ShiftSchedule[]        @relation("ShiftScheduleToUser")
  authorizedControlPoints  ControlPoint[]         @relation("ControlPointUsers")
  controlLogs              ControlLog[]
}

model Role {
  id                       Int            @id @default(autoincrement())
  name                     String         @unique
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @default(now()) @updatedAt
  approvalItems            Item[]         @relation("ItemApprovalRoles")
  periods                  Period[]       @relation("PeriodRoles")
  permissions              Permission[]   @relation("PermissionToRole")
  shiftTypes               ShiftType[]    @relation("RoleToShiftType")
  users                    User[]         @relation("RoleToUser")
  authorizedControlPoints  ControlPoint[] @relation("ControlPointRoles")
}

model Permission {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  roles     Role[]   @relation("PermissionToRole")
}

model Period {
  id                  Int               @id @default(autoincrement())
  name                String
  start               DateTime
  end                 DateTime
  visibleStart        DateTime
  visibleEnd          DateTime
  scheduleSignupStart DateTime
  scheduleSignupEnd   DateTime
  scheduleModifyStart DateTime
  scheduleModifyEnd   DateTime
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @default(now()) @updatedAt
  max                 Int?
  min                 Int?
  minMaxUnit          MinMaxUnit?
  periodExceptions    PeriodException[]
  shiftTypes          ShiftType[]
  roles               Role[]            @relation("PeriodRoles")
}

model PeriodException {
  id        Int      @id @default(autoincrement())
  periodId  Int
  name      String
  start     DateTime
  end       DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  period    Period   @relation(fields: [periodId], references: [id], onDelete: Cascade)
}

model ShiftType {
  id                      Int                      @id @default(autoincrement())
  periodId                Int
  name                    String
  location                String
  description             String?
  color                   String?
  icon                    String?
  isBalancedAcrossOverlap Boolean                  @default(false)
  isBalancedAcrossDay     Boolean                  @default(false)
  isBalancedAcrossPeriod  Boolean                  @default(false)
  canSelfAssign           Boolean                  @default(true)
  doRequireRoles          ShiftTypeRoleRequirement @default(disabled)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @default(now()) @updatedAt
  shiftSchedules          ShiftSchedule[]
  period                  Period                   @relation(fields: [periodId], references: [id], onDelete: Cascade)
  roles                   Role[]                   @relation("RoleToShiftType")
}

model ShiftSchedule {
  id               Int               @id @default(autoincrement())
  shiftTypeId      Int
  slots            Int               @default(1)
  dayOfWeek        Int
  startTime        String
  endTime          String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @default(now()) @updatedAt
  shiftOccurrences ShiftOccurrence[]
  shiftType        ShiftType         @relation(fields: [shiftTypeId], references: [id], onDelete: Cascade)
  users            User[]            @relation("ShiftScheduleToUser")

  @@unique([shiftTypeId, dayOfWeek, startTime])
}

model ShiftOccurrence {
  id              Int               @id @default(autoincrement())
  shiftScheduleId Int
  timestamp       DateTime
  slot            Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @default(now()) @updatedAt
  attendances     ShiftAttendance[]
  shiftSchedule   ShiftSchedule     @relation(fields: [shiftScheduleId], references: [id], onDelete: Cascade)
  users           User[]            @relation("ShiftOccurrenceToUser")

  @@unique([shiftScheduleId, timestamp, slot])
}

model ShiftAttendance {
  id                Int                   @id @default(autoincrement())
  shiftOccurrenceId Int
  userId            Int
  status            ShiftAttendanceStatus @default(absent)
  timeIn            DateTime?
  timeOut           DateTime?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @default(now()) @updatedAt
  didArriveLate     Boolean               @default(false)
  didLeaveEarly     Boolean               @default(false)
  droppedNotes      String?
  isMakeup          Boolean               @default(false)
  excuseNotes       String?
  isExcused         Boolean               @default(false)
  reviewedAt        DateTime?
  reviewedById      Int?
  reviewedBy        User?                 @relation("ShiftAttendanceReviewedBy", fields: [reviewedById], references: [id])
  shiftOccurrence   ShiftOccurrence       @relation(fields: [shiftOccurrenceId], references: [id], onDelete: Cascade)
  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([shiftOccurrenceId, userId])
}

model Session {
  id                Int         @id @default(autoincrement())
  userId            Int
  startedAt         DateTime    @default(now())
  endedAt           DateTime?
  sessionType       SessionType @default(regular)
  isManuallyCreated Boolean     @default(false)
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endedAt])
}

model Device {
  id                 Int                @id @default(autoincrement())
  name               String
  ipAddress          String             @unique
  isActive           Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @default(now()) @updatedAt
  hasDashboardAccess Boolean            @default(false)
  hasKioskAccess     Boolean            @default(true)
  hasInventoryAccess Boolean            @default(false)
  hasControlAccess   Boolean            @default(false)
  securitySnapshots  SecuritySnapshot[]
  controlPoints      ControlPoint[]     @relation("DeviceControlPoints")
}

model Agreement {
  id               Int             @id @default(autoincrement())
  title            String
  content          String
  confirmationText String
  isEnabled        Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @default(now()) @updatedAt
  userAgreements   UserAgreement[]
}

model UserAgreement {
  id          Int       @id @default(autoincrement())
  userId      Int
  agreementId Int
  agreedAt    DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt
  agreement   Agreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, agreementId])
}

model ApiToken {
  id          Int        @id @default(autoincrement())
  name        String
  description String?
  prefix      String     @unique
  hashedKey   String     @unique
  createdById Int?
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt
  createdBy   User?      @relation(fields: [createdById], references: [id])
  auditLogs   AuditLog[]
}

model AuditLog {
  id               Int            @id @default(autoincrement())
  userId           Int
  impersonatedById Int?
  apiTokenId       Int?
  action           String
  metadata         Json           @default("{}")
  source           AuditLogSource
  createdAt        DateTime       @default(now())
  apiToken         ApiToken?      @relation(fields: [apiTokenId], references: [id])
  impersonatedBy   User?          @relation("AuditLogImpersonators", fields: [impersonatedById], references: [id])
  user             User           @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([apiTokenId, createdAt])
  @@index([action, createdAt])
}

model OneTimeAccessCode {
  id        Int       @id @default(autoincrement())
  code      String    @unique
  usedAt    DateTime?
  expiresAt DateTime
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now()) @updatedAt

  @@index([code, expiresAt])
}

model ConfigValue {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([key])
}

model Suspension {
  id            Int       @id @default(autoincrement())
  userId        Int
  startDate     DateTime
  endDate       DateTime
  internalNotes String?
  externalNotes String?
  createdById   Int?
  emailSentAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  createdBy     User?     @relation("SuspensionCreatedBy", fields: [createdById], references: [id])
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startDate, endDate])
  @@index([emailSentAt, startDate])
}

model Item {
  id            String                 @id @default(uuid())
  name          String
  description   String?
  sku           String?                @unique
  location      String?
  minQuantity   Int?
  isActive      Boolean                @default(true)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @default(now()) @updatedAt
  link          String?
  snapshot      InventorySnapshot?
  transactions  InventoryTransaction[]
  approvalRoles Role[]                 @relation("ItemApprovalRoles")
}

model InventoryTransaction {
  id        String          @id @default(uuid())
  itemId    String
  userId    Int
  action    InventoryAction
  quantity  Int
  notes     String?
  createdAt DateTime        @default(now())
  item      Item            @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id])

  @@index([itemId, createdAt])
}

model InventorySnapshot {
  itemId   String   @id
  quantity Int
  takenAt  DateTime @default(now())
  item     Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
}

model TicketType {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  description  String?
  icon         String?
  color        String?
  requiresAuth Boolean  @default(false)
  isActive     Boolean  @default(true)
  sortOrder    Int      @default(0)
  fieldSchema  Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
  tickets      Ticket[]
}

model Ticket {
  id              String                @id @default(uuid())
  ticketTypeId    Int
  status          TicketStatus          @default(pending)
  data            Json
  submitterId     Int?
  submitterEmail  String?
  submitterName   String?
  handlerId       Int?
  internalNotes   String?
  resolutionNotes String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @default(now()) @updatedAt
  resolvedAt      DateTime?
  handler         User?                 @relation("TicketHandler", fields: [handlerId], references: [id])
  submitter       User?                 @relation("TicketSubmitter", fields: [submitterId], references: [id])
  ticketType      TicketType            @relation(fields: [ticketTypeId], references: [id])
  statusHistory   TicketStatusHistory[]

  @@index([ticketTypeId])
  @@index([submitterId])
  @@index([handlerId])
  @@index([status])
  @@index([createdAt])
}

model TicketStatusHistory {
  id             Int           @id @default(autoincrement())
  ticketId       String
  previousStatus TicketStatus?
  newStatus      TicketStatus
  notes          String?
  changedById    Int?
  createdAt      DateTime      @default(now())
  changedBy      User?         @relation("TicketStatusChangedBy", fields: [changedById], references: [id])
  ticket         Ticket        @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([createdAt])
}

model SecuritySnapshot {
  id             String            @id @default(uuid())
  deviceId       Int?
  userId         Int?
  eventType      SecurityEventType
  imagePath      String
  capturedAt     DateTime          @default(now())
  faceDetected   Boolean           @default(false)
  faceConfidence Float?
  createdAt      DateTime          @default(now())
  device         Device?           @relation(fields: [deviceId], references: [id])
  user           User?             @relation(fields: [userId], references: [id])

  @@index([deviceId])
  @@index([userId])
  @@index([capturedAt])
  @@index([eventType])
}

enum ShiftTypeRoleRequirement {
  disabled
  all
  any
}

enum ShiftAttendanceStatus {
  upcoming
  present
  absent
  dropped
  dropped_makeup
  excused
}

enum SessionType {
  regular
  staffing
}

enum MinMaxUnit {
  count
  minutes
  hours
}

enum AuditLogSource {
  trpc
  rest
  slack
}

enum InventoryAction {
  CHECK_IN
  CHECK_OUT
}

enum TicketStatus {
  pending
  in_progress
  resolved
  closed
  cancelled
}

enum SecurityEventType {
  TAP
  PRESENCE // Snapshot taken when face is detected but no tap event occurs
}

// ===== Equipment Control System =====

model ControlProvider {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  providerType  ControlProviderType
  config        Json           @default("{}")
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @default(now()) @updatedAt
  controlPoints ControlPoint[]
}

model ControlPoint {
  id                  String            @id @default(uuid())
  name                String
  description         String?
  location            String?
  controlClass        ControlClass
  canControlOnline    Boolean           @default(true)
  canControlWithCode  Boolean           @default(false)
  providerConfig      Json              @default("{}")
  currentState        Boolean           @default(false)
  autoTurnOffEnabled  Boolean           @default(false)
  autoTurnOffMinutes  Int?
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @default(now()) @updatedAt
  providerId          Int
  provider            ControlProvider   @relation(fields: [providerId], references: [id], onDelete: Restrict)
  authorizedRoles     Role[]            @relation("ControlPointRoles")
  authorizedUsers     User[]            @relation("ControlPointUsers")
  controlLogs         ControlLog[]
  devices             Device[]          @relation("DeviceControlPoints")

  @@index([providerId])
}

model ControlLog {
  id             String       @id @default(uuid())
  controlPointId String
  userId         Int
  action         ControlAction
  previousState  Boolean?
  newState       Boolean?
  success        Boolean      @default(true)
  errorMessage   String?
  createdAt      DateTime     @default(now())
  controlPoint   ControlPoint @relation(fields: [controlPointId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id])

  @@index([controlPointId, createdAt])
  @@index([userId, createdAt])
}

enum ControlProviderType {
  GEORGIA_TECH_PLC
}

enum ControlClass {
  SWITCH  // On/off toggle with persistent state
  DOOR    // Momentary unlock, no persistent state
}

enum ControlAction {
  TURN_ON
  TURN_OFF
  UNLOCK
  READ_STATE
}
